<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="content-type" content="text/html;charset=UTF-8" />
<title>
<%= session[:organisation].name if session.has_key?(:organisation) %>
<%= " - " + @school.displayName if not @school.nil? %>
</title>
<%= stylesheet_link_tag "#{theme}/screen.css", :media => 'screen, projection' %>
<%= stylesheet_link_tag "#{theme}/print.css", :media => 'print' %>
<%= stylesheet_link_tag "#{theme}/topmenu.css" %>
<%= stylesheet_link_tag "#{theme}/navmenu.css" %>
<%= stylesheet_link_tag "#{theme}/puavo.css" %>
<%= stylesheet_link_tag "jquery.liveSearch" %>

<%= javascript_include_tag "jquery-1.4.2.min", "rails", "application", "jquery.liveSearch" %>
<% if theme!="gray" %> <%= javascript_include_tag "new_themes" %> <% end %>
<% search_urls = { "devices-search" => "/devices/search?words=" } %>
<% if PUAVO_CONFIG["puavo_users"] == "enabled" then search_urls["users-search"] = "/users/search?words=" end %>
<%= javascript_tag "var search_urls = { " + search_urls.map{ |key, value| "'#{key}': '#{value}'" }.join(", ") + " };" %>

<%= yield :javascript %>

<meta name="csrf-token" content="<%= form_authenticity_token %>" />
<meta name="csrf-param" content="authenticity_token" />
</head>
<body>
  <% if theme!="gray"%>
    <div class="topNavContainer">
      <div class="topNavContentContainer">
        <ul id="top-menu">
          <% if organisation_owner? %>
          <li>
            <% if puavo_users? %>
              <%= link_to session[:organisation].name, "/users/organisation", :class => "sub" %>
              <% else %>
              <span class="sub"><%= session[:organisation].name %></span>
            <% end %>
            <ul id="help">
              <% if puavo_users? %>
                <li><%= link_to t('.external_services'),  "/users/organisation"%></li>
              <% end %>
                <li><%= link_to t('.printers'), printers_path %></li>
                <li><%= link_to t('.servers'), servers_path %></li>
            </ul>
          </li>
          <% else %>
          <li><span class="sub"><%= session[:organisation].name %></span></li>
          <% end %>
          <li>
            <% if puavo_users? %>
              <%= link_to t('.schools'), "/users/schools", :class => "sub" %>
              <% else %>
              <span class="sub"><%= t('.schools') %></span>
            <% end %>
            <ul>
              <% session[:organisation].schools.each do |school| %>
                <li<% if session[:organisation].schools.last == school %> class="last"<% end %>>
                  <%= link_to school.displayName,  devices_path(school) %>
                </li>
              <% end %>
            </ul>
          </li>
          <li>
            <%= text_field_tag( "search",
            nil,
            :id => "search",
            :size => 30,
            :placeholder => t('.search_placeholder') ) %>
          </li>
        </ul> <!-- top-menu -->

        <ul id="top-menu-right" class="menu">
          <li><span><%= t('.logged_in_as') %></span></li>
          <li><a href="#"><%= current_user_displayName %></a></li>
          <li><%= link_to t('.logout'), logout_path, :method => :delete %></li>
        </ul>
      </div><!-- topNavContentContainer -->
    </div><!-- topNavContainer -->
  <% end %>

  <div id="container" class="container">
    <div class="container_wrap">
      <% if theme=="gray"%>
        <ul id="top-menu" class="menu">
          <% if organisation_owner? %>
            <li>
              <% if puavo_users? %>
                <%= link_to session[:organisation].name, "/users/organisation", :class => "sub" %>
              <% else %>
                <span class="sub"><%= session[:organisation].name %></span>
              <% end %>
              <ul>
                <% if puavo_users? %>
                  <li><%= link_to t('.external_services'), "/users/external_services" %></li>
                <% end %>
                  <li><%= link_to t('.printers'), printers_path %></li>
                  <li><%= link_to t('.servers'), servers_path %></li>
               </ul>
            </li>
            <% else %>
              <li><span class="sub"><%= session[:organisation].name %></span></li>
            <% end %>
            <li>
              <% if puavo_users? %>
                <%= link_to t('.schools'), "/users/schools", :class => "sub" %>
              <% else %>
                <span class="sub"><%= t('.schools') %></span>
              <% end %>
              <ul>
                <% session[:organisation].schools.each do |school| %>
                  <li<% if session[:organisation].schools.last == school %> class="last"<% end %>><%= link_to school.displayName,  devices_path(school) %></li>
                  <% end %>
              </ul>
            </li>
            <% if logged_in? %>
              <div id="top-menu-right">
                <li>
                  <%= text_field_tag( "search",
                  nil,
                  :id => "search",
                  :size => 30,
                  :placeholder => t('.search_placeholder') ) %>
                </li>
                <li><span><%= t('.logged_in_as') %></span></li>
                <li><a href="#"><%= current_user_displayName %></a></li>
                <li><%= link_to t('.logout'), logout_path, :method => :delete %></li>
              </div><!-- top-menu-right -->
            <% end %>
          </ul> <!-- top-menu -->
          <hr class="space" />
        <% end %>
        <% if session[:organisation] %>
        <% if @school && !@school.id.nil? %>
          <h1><%= @school.displayName %></h1>
          <div id="navbar_first_level">
            <div id="nav1">
              <ul>
                <% if puavo_users? %>
                  <li class="page_item">
                    <% link_to "/users/schools/#{@school.id}" do %><span><%= t('.school') %></span><% end %>
                  </li>
                  <li class="page_item">
                    <% link_to "/users/#{@school.id}/users" do %><span><%= t('.users') %></span><% end %>
                  </li>
                <% end %>
                <li class="<%= controller_name.match(/devices/) ? "page_item current_page_item" : "page_item" %>">
                  <% link_to devices_path(@school) do %> <span><%= t('.devices') %></span><% end %>
                </li>
                <% if @oauth_applications %>
                  <% @oauth_applications.each do |app| %>
                    <li class="page_item"><a href="<%= app.url %>" title="<%= app.name %>"><span><%= app.name %></span></a></li>
                  <% end %>
                <% end %>
              </ul>
            </div><!-- nav1 -->
          </div><!-- navbar_first_level -->
          <div id="navbar_second_level">&nbsp;
            <%= render :partial => "#{controller_name}/menu.html.erb" rescue nil %>
          </div><!-- navbar_second_level -->
        <% end %>
        <% end %>

        <hr class="space" />
        <div class="wrap">
          <div class="maincontent">
              
              <% if message_keys = flash.keys.select { |key| [:error, :notice, :success, :alert].include?(key) } %>
                <% message_keys.each do |key| %>
                  <p class="message_<%= key %>"> <%= flash[key] %></p>
                <% end %>
              <% end %>
              <% if theme!="gray" %> 
              <% if current_user %>
                <div class="tools">
                  <%= yield :right %>
                </div>
              <% end %>
              <%= yield %>
            </div> <!-- maincontent -->
          <% end %> 

           <% if theme=="gray" %>  
            <%= yield %>
          </div> <!-- maincontent -->
          <% if logged_in? %>
            <div class="tools">
              <h1><%= t('.tools') %></h1>
              <%= yield :right %>
            </div>
          <% end %>
        <% end %>

      </div> <!-- wrap -->
    </div> <!-- container_wrap-->
  </div> <!-- container -->
</body>
</html>
